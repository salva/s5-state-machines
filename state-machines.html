<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" 
	"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">

<head>
<title>AnyEvent + Class::StateMachine</title>
<!-- metadata -->
<meta name="generator" content="S5" />
<meta name="version" content="S5 1.1" />
<meta name="presdate" content="20130731" />
<meta name="author" content="Salvador Fandi&ntilde;o" />
<!-- meta name="company" content="Complex Spiral Consulting" /-->
<!-- configuration parameters -->
<meta name="defaultView" content="slideshow" />
<meta name="controlVis" content="hidden" />
<!-- style sheet links -->
<link rel="stylesheet" href="ui/default/slides.css" type="text/css" media="projection" id="slideProj" />
<link rel="stylesheet" href="ui/default/outline.css" type="text/css" media="screen" id="outlineStyle" />
<link rel="stylesheet" href="ui/default/print.css" type="text/css" media="print" id="slidePrint" />
<link rel="stylesheet" href="ui/default/opera.css" type="text/css" media="projection" id="operaFix" />
<!-- S5 JS -->
<script src="ui/default/slides.js" type="text/javascript"></script>
</head>
<body>

<div class="layout">
<div id="controls"><!-- DO NOT EDIT --></div>
<div id="currentSlide"><!-- DO NOT EDIT --></div>
<div id="header"></div>
<div id="footer">
<h1>YAPC::Europe 2013</h1>
<h2>AnyEvent + Class::StateMachine</h2>
</div>

</div>


<div class="presentation">

<div class="slide">
<h1>AnyEvent + Class::StateMachine</h1>
<h2>Writing maintenable event-driven programs</h2>
<h3>Salvador Fandi&ntilde;o</h3>
<h4>(sfandino@yahoo.com)</h4>
</div>

<!--div class="slide">
<h1>Index</h1>
<ul>
<li>[point one]</li>
<li>[point two]</li>
<li>[point three]</li>
<li>[point four]</li>
<li>[point five]</li>
</ul>
<div class="handout">
</div>
</div-->

<!--div class="slide">
<h1>Introduction</h1>
</div-->

<div class="slide">
<h1>Event-driven programming</h1>

<h2>Wikipedia definition:</h2>
<i>
<p>Event-driven programming is a programming paradigm in which the flow
of the program is determined by events.

<p>It can also be defined as an application architecture technique in
which the application has a main loop which is clearly divided down to
two sections:

<ul>
<li>the first is event selection</li>
<li>the second is event handling</li>
</ul>
</i>
<div class="handout">
</div>
</div>

<div class="slide">
<h1>AnyEvent</h1>

<h2>Event selection:</h2>

<p>AnyEvent + backends (i.e. EV)

<h2>Event handling:</h2>

<p>Callbacks...

<ul>
<li>very flexible</li>
<li>lead to spaghetti code</li>
</ul>
</div>

<div class="slide">
<h1>Event-driven programming, callbacks and spaghetti code</h1>
<p>Regular, well-written, non event-driven programs (OO or not), are
usually structured in a top-down style where high level functions call
lower level ones.

<p>On the event-driven case, the program is divided attending
exclusively at the non-blocking criteria into a flat set of small
blocks. There is no structure or hierarchie on the code, just a bunch
of subroutines that are invoked in a non-explicit order from the event
loop.

<p>In order to share information between the callbacks, state has to
maintained at and outer scope (i.e inside global variables or
objects).
</div>

<div class="slide">
<h1>(Finite) State machines</h1>

<h2>Wikipedia definition:</h2>

<i>
<p>A state machine, is conceived as an abstract machine that can be in
one of a finite number of states. 

<p>The machine is in only one state at a time; the state it is in at
any given time is called the current state. 

<p>It can change from one state to another when initiated by a
triggering event or condition; this is called a transition. 

</div>

<div class="slide">
<h1>State machines</h1>

<h2>Defining a state machine:</h2>

<ul>
  <li><b>states</b></li>
  <li><b>events</b> and <b>transitions</b></li>
</ul>

<p>In practice, there are also...

<ul>
  <li><b>actions</b> that are run...</li>
  <ul>
    <li>on entering some state</li>
    <li>on leaving some state</li>
    <li>on some transition</li>
    <li>when some event happens</li>
  </ul>
</ul>
</div>

<div class="slide">
<h1>Event-driven programming and state machines</h1>

State machines allow use to structure event-driven programs:

<ul>
  <li>An state machine is an object</li>
  <li>An event-driven program is composed of multiple state-machines</li> 
  <li>The states, events and transitions can be defined using some domain specific language (DSL)</li>
  <li>State machines objects can also be viewed as agents running in parallel</li>
  <li>The states, events and transitions define the agent flow</li>
  <li>The small, non-blocking, calls become the actions</li>
</ul>

</div>

<div class="slide">
<h1>POE::NFA - nondeterministic finite automaton</h1>
<pre>
POE::NFA->spawn(
    inline_states => {
      initial => {
        setup => \&setup_stuff,
      },
      state_login => {
        on_entry => \&login_prompt,
        on_input => \&save_login,
      },
      state_password => {
        on_entry => \&password_prompt,
        on_input => \&check_password,
      },
      state_cmd => {
        on_entry => \&command_prompt,
        on_input => \&handle_command,
      },
    },
  )->goto_state(initial => "setup");
</pre>
</div>

<div class="slide">
<h1>CPAN</h1>
<p>Lots of modules: <b>POE::NFA</b>, FSA::Engine, FSA::Rules, FSM::Simple, Basset::Machine, etc...
<p>No one is perfect!

<ul>
<li>Too abstract, too theorical, too generic</li>
<li>Oriented towards some specific task (i.e. parsing)</li>
<li>Specific to some framework</li>
<li>Not very efficient</li>
<li>...</li>
</ul>

</div>

<div class="slide">
<h1>Class::StateMachine</h1>

<p>Initially (2006)...

<ul>
<li>A light framework for implementing very efficient state-machines</li>
<li>The focus was on event-driven/network applications</li>
<li>Yet, generic</li>
<li>Low level</li>
<li>Event dispatching was the only feature supported</li>
<li>Sophisticated blend between OOP and state-machines</li>
<li>Scary implementation</li>
</ul>
</div>

<div class="slide">
<h1>Class::StateMachine</h1>

<p>Today...

<ul>
<li>Evolved guided by practical requirements</li>
<li>Lots of belts and whistles</li>
<li>Class::StateMachine is still a low level framework</li>
<li>Scary implementation, but it uses <b>mro</b> now</li>
<li>Class::StateMachine::Declarative is high level companion</li>
</li>

</ul>

</div>

<div class="slide">
<h1>Class::StateMachine::Declarative</h1>
<p>An opinionated high-level framework for building state-machines.

<p>The aim is code clarity and maintainability.

<p>Quite complex state-machines (tens of states).

<p>It solves my problem quite well.

<p>...don't know about yours.

<p>Still a work in progress, still learning.

</div>

<div class="slide">
<h1>Class::StateMachine::Declarative - Usage</h1>

<p>Derive from Class::StateMachine...

<pre>
use parent qw(Class::StateMachine); 
</pre>

<p>Use Class::StateMachine::Declarative to declare the state-machine
states, transitions and actions:

<pre>
use Class::StateMachine::Declarative
  foo => { ... },
  bar => { ... };
</pre>

</div>

<div class="slide">
<h1>Class::StateMachine::Declarative</h1>
<h2>Basic features:</h2>
<p><pre>
use Class::StateMachine::Declarative

    $state_name => { enter => $enter_action,

                     leave => $leave_action,

                     transitions => { $event => $target_state,
                                      ...
                                    }
                   },
    ...
</pre>
</div>

<div class="slide">
<h1>Class::StateMachine::Declarative</h1>
<h2>Example:</h2>
<p><pre>
use Class::StateMachine::Declarative
  new              => { transitions => { run => 'asking_for_login' } },

  asking_for_login => { enter => 'print_login_prompt',
                        transitions => { got_login => 'password' } },

  asking_for_pwd   => { enter => 'print_pwd_prompt',
                        transitions => { got_pwd => 'asking_for_cmd',
                                         got_pwd_error => 'asking_for_login' } },

  asking_for_cmd   => { enter => 'print_cmd_prompt',
                        transitions => { got_cmd => 'running_cmd' } },

  running_cmd      => { enter => 'run_cmd',
                        transitions => { cmd_done => 'asking_for_cmd' } };
</pre>
</div>

<div class="slide">
<h1>Class::StateMachine::Declarative</h1>
<h2>Inheritance between states:</h2>
<ul>
<li>Substates:
<p><pre>
$state_name => { ...,
                 substates => [ $substate_name => \%substate_decl,
                                ... ],
               }
</pre>
</li>
<li>The <b>__any__</b> state</li>
</ul>
</div>

<div class="slide">
<h2>Other keywords</h2>
<ul>
<li>before: running an action before some event triggers a transition.
<p><pre>
$state_name => { before => { $event_name => $method_name,
                             ...
                           },
                 ...,
               }
</pre>
</li>
<li>advance: moving forward is so common!
<p><pre>
$state_name => { advance => $event_name,
                 ... }
                 
</pre>
</li>
</ul>
</div>



<div class="slide">
<h1>Class::StateMachine::Declarative</h1>
<h2>Example:</h2>
<pre>
use Class::StateMachine::Declarative
  __any__ => { advance => 'on_done',
               transitions => { on_closed => 'stopped' } },

  auth    => { transitions => { on_error => 'login' },
               substates => [ login => { enter => 'ask_login },
                              pwd   => { enter => 'ask_pwd' },
                                         before => { done => 'check_pwd' } } ] },

  repl    => { transitions => { on_error => 'ask' },
               substates => [ ask => { enter => ask_cmd },
                              run => { enter => run_cmd,
                                       transitions => { on_done => ask } } ] },

  stopped => { enter => 'tell_owner' };

</pre>
</div>

<div class="slide">
<h1>Class::StateMachine::Declarative - Usage</h1>

<p>Yes, You need a wide monitor to use Class::StateMachine::Declarative!!!

</div>

<div class="slide">
<h1>[slide title]</h1>
<ul>
<li>[point one]</li>
<li>[point two]</li>
<li>[point three]</li>
<li>[point four]</li>
<li>[point five]</li>
</ul>
<div class="handout">
</div>
</div>


</div>

</body>
</html>
